name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g. v0.3.0)'
        required: true

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || github.ref }}

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install frontend dependencies
        run: bun install --frozen-lockfile

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ inputs.tag || github.ref_name }}
          releaseName: '텔레그램 한국어 검색 ${{ inputs.tag || github.ref_name }}'
          releaseBody: |
            ## 설치 방법

            아래에서 `.dmg` 파일을 다운로드하여 설치하세요.

            > **참고**: 이 앱은 코드 서명이 되어 있지 않습니다. 처음 실행할 때 앱을 우클릭하고 "열기"를 선택한 후, 대화상자에서 "열기"를 클릭하세요. 한 번만 하면 됩니다.
          releaseDraft: false
          prerelease: false
          args: --target aarch64-apple-darwin
